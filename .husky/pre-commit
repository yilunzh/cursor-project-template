#!/bin/sh
# Pre-commit hook: Run tests and lint, warn about main branch commits
# Language-agnostic: Auto-detects test runner and linter based on project files

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Check if committing to main branch
BRANCH=$(git branch --show-current)
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
    echo "${YELLOW}WARNING: You are committing directly to $BRANCH${NC}"
    echo "Consider using a feature branch instead:"
    echo "  git checkout -b feature/<feature-name>"
    echo ""
    # Allow but warn - remove 'exit 1' comment below to block
    # exit 1
fi

# Detect and run linter
run_linter() {
    # Node.js linters
    if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ] || [ -f "eslint.config.mjs" ]; then
        echo "Running ESLint..."
        npx eslint . --max-warnings=0
        return $?
    fi

    # Python linters
    if [ -f "pyproject.toml" ] && grep -q "ruff" "pyproject.toml" 2>/dev/null; then
        echo "Running Ruff..."
        ruff check .
        return $?
    fi
    if [ -f ".flake8" ] || [ -f "setup.cfg" ]; then
        echo "Running Flake8..."
        flake8
        return $?
    fi

    # Rust linter
    if [ -f "Cargo.toml" ]; then
        echo "Running Cargo Clippy..."
        cargo clippy -- -D warnings
        return $?
    fi

    # Go linter
    if [ -f "go.mod" ]; then
        echo "Running Go Vet..."
        go vet ./...
        return $?
    fi

    return 0
}

# Detect and run tests
run_tests() {
    # Node.js projects
    if [ -f "package.json" ]; then
        if grep -q '"test"' package.json 2>/dev/null; then
            echo "Running npm test..."
            npm test
            return $?
        fi
        if [ -f "vitest.config.ts" ] || [ -f "vitest.config.js" ]; then
            echo "Running Vitest..."
            npx vitest run
            return $?
        fi
        if [ -f "jest.config.js" ] || [ -f "jest.config.ts" ]; then
            echo "Running Jest..."
            npx jest
            return $?
        fi
    fi

    # Python projects
    if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
        if [ -f "pytest.ini" ] || [ -f "conftest.py" ] || ([ -f "pyproject.toml" ] && grep -q "pytest" "pyproject.toml" 2>/dev/null); then
            echo "Running Pytest..."
            pytest -v --tb=short -q
            return $?
        fi
        echo "Running Python unittest..."
        python -m unittest discover
        return $?
    fi

    # Rust projects
    if [ -f "Cargo.toml" ]; then
        echo "Running Cargo Test..."
        cargo test
        return $?
    fi

    # Go projects
    if [ -f "go.mod" ]; then
        echo "Running Go Test..."
        go test ./...
        return $?
    fi

    echo "${YELLOW}No test runner detected${NC}"
    return 0
}

# Run checks
LINT_RESULT=0
TEST_RESULT=0

run_linter
LINT_RESULT=$?

run_tests
TEST_RESULT=$?

# Report results
if [ $LINT_RESULT -ne 0 ]; then
    echo ""
    echo "${RED}Lint check failed!${NC}"
    echo "Fix lint errors before committing."
    exit 1
fi

if [ $TEST_RESULT -ne 0 ]; then
    echo ""
    echo "${RED}Tests failed!${NC}"
    echo "Fix failing tests before committing."
    exit 1
fi

echo ""
echo "${GREEN}All checks passed!${NC}"
exit 0
